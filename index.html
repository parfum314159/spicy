<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spicy Library Pi</title>

  <style>
    body { font-family: Arial; background-color:#111; color:#fff; margin:0; padding:20px;}
    h1 { color:#ff4500; }
    .books-container { display:flex; flex-wrap:wrap; }
    .book { border:1px solid #444; padding:10px; margin:10px; border-radius:8px; background-color:#222; max-width:250px; text-align:center; }
    .book img { width:200px; margin-bottom:10px; }
    button { padding:6px 12px; border-radius:5px; border:none; cursor:pointer; margin-top:5px; }
    button.pi-pay { background-color:#00b300; color:white; }
    button.pi-pay:hover { background-color:#00d000; }
    #bookDetails { display:none; border:1px solid #444; padding:20px; border-radius:8px; background-color:#222; margin-bottom:20px; }
    #bookDetails img { width:300px; display:block; margin-bottom:10px; }
    #backBtn { background-color:#ff4500; color:white; margin-bottom:10px; }
    #backBtn:hover { background-color:#ff6347; }
    #userLibrary { border:1px solid #444; padding:10px; border-radius:8px; background-color:#222; margin-bottom:20px; max-width:400px; display:none; }
    #outsideWarning { display:none; color:#ff4444; font-weight:bold; margin-bottom:20px; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Pi SDK -->
  <script src="https://web.minepi.com/pi.js"></script>
</head>

<body>

<h1>?? Spicy Library Pi</h1>

<div id="outsideWarning">
  You must open this website inside Pi Browser for login and payments!
</div>

<!-- User Library -->
<div id="userLibrary">
  <h2>Your Library</h2>
  <div id="myBooks"></div>
  <button onclick="logout()">Logout</button>
</div>

<hr>

<!-- Book Details -->
<div id="bookDetails">
  <button id="backBtn" onclick="showBooks()">? Back</button>
  <div id="detailsContent"></div>
</div>

<!-- Books -->
<div id="booksContainer" class="books-container"></div>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBwfwugnPYvdsL4wApe1QF5IM6QTwZwbms",
  authDomain: "spicy-f2a1b.firebaseapp.com",
  projectId: "spicy-f2a1b",
  storageBucket: "spicy-f2a1b.firebasestorage.app",
  messagingSenderId: "393201465836",
  appId: "1:393201465836:web:70e0ee76581d16bed868c9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= Books ================= */
const books = [
  { title:"Love Story", author:"Asmanour", pricePi:5, cover:"cover1.jpg", description:"A hidden childhood love grows into eternal marriage." },
  { title:"Adventure Tales", author:"John Doe", pricePi:3, cover:"cover2.jpg", description:"Exciting adventures full of mystery and courage." },
  { title:"Tech & Web3", author:"Jane Smith", pricePi:7, cover:"cover3.jpg", description:"Discover blockchain and decentralized technology." }
];

let currentUser = null;

const booksContainer = document.getElementById("booksContainer");
const bookDetails = document.getElementById("bookDetails");
const detailsContent = document.getElementById("detailsContent");
const myBooksDiv = document.getElementById("myBooks");
const outsideWarning = document.getElementById("outsideWarning");

/* ================= UI ================= */
function showBooks(){
  bookDetails.style.display="none";
  booksContainer.style.display="flex";
}

function showBookDetail(index){
  const b = books[index];
  booksContainer.style.display="none";
  bookDetails.style.display="block";
  detailsContent.innerHTML = `
    <img src="${b.cover}">
    <h2>${b.title}</h2>
    <p><b>Author:</b> ${b.author}</p>
    <p><b>Price:</b> ${b.pricePi} Pi</p>
    <p>${b.description}</p>
    <button class="pi-pay" onclick="payWithPi('${b.title}', ${b.pricePi})">Pay with Pi</button>
  `;
}

books.forEach((b,i)=>{
  const div=document.createElement("div");
  div.className="book";
  div.innerHTML=`
    <img src="${b.cover}">
    <h3 onclick="showBookDetail(${i})" style="cursor:pointer">${b.title}</h3>
    <p>${b.author}</p>
    <p>${b.pricePi} Pi</p>
    <button class="pi-pay" onclick="payWithPi('${b.title}', ${b.pricePi})">Pay with Pi</button>
  `;
  booksContainer.appendChild(div);
});

/* ================= Pi Login ================= */
async function loginPi(){
  try {
    if (typeof Pi === "undefined") {
      outsideWarning.style.display="block";
      return;
    }

    const scopes = ['username','payments'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

    currentUser = auth.user.uid;
    document.getElementById("userLibrary").style.display="block";
    displayUserLibrary();

  } catch(e){
    console.error(e);
    alert("Pi login failed");
  }
}

function onIncompletePaymentFound(payment){
  console.log("Incomplete payment:", payment);
}

/* ================= Payment ================= */
async function payWithPi(title, price){
  if(!currentUser){
    await loginPi();
    if(!currentUser) return;
  }

  try {
    await Pi.createPayment({
      amount: price,
      memo: "Buy " + title,
      metadata: { book:title }
    });

    const userRef = db.collection("users").doc(currentUser);
    await userRef.set({
      books: firebase.firestore.FieldValue.arrayUnion(title)
    }, { merge:true });

    alert("Payment requested ?");
    displayUserLibrary();

  } catch(e){
    console.error(e);
    alert("Payment failed");
  }
}

/* ================= Library ================= */
async function displayUserLibrary(){
  const doc = await db.collection("users").doc(currentUser).get();
  const books = doc.exists ? doc.data().books || [] : [];
  myBooksDiv.innerHTML = books.length
    ? books.map(b=>`<p>${b}</p>`).join("")
    : "<p>No books yet</p>";
}

function logout(){
  currentUser=null;
  document.getElementById("userLibrary").style.display="none";
  showBooks();
}

showBooks();
</script>

</body>
</html>
